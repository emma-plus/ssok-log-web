# AI 분석 파이프라인 - 유사어 분석 시스템 with STT 메트릭

## 개요
이 프로젝트는 사용자가 입력한 답변과 정답 간의 유사도를 AI로 분석하여, 운영자가 유사어 후보들을 승인/거절할 수 있는 웹 기반 시스템입니다. STT(Speech-to-Text) 특화 메트릭을 포함한 다양한 유사도 계산 방식을 지원하며, **단어 분석**과 **문장 분석** 모두를 지원합니다.

## 🚀 빠른 시작 및 테스트

### 1. 실시간 분석 (index.html)
- `index.html`을 브라우저에서 열기
- OpenAI API 키 입력 또는 "OpenAI 미사용" 체크
- CSV/TSV 데이터 입력 후 분석 시작

### 2. 분석 결과 뷰어 테스트 (load-json.html)
프로젝트에 포함된 샘플 JSON 파일을 사용하여 결과 뷰어를 즉시 테스트할 수 있습니다:

#### 📁 포함된 테스트 파일
```
result_embedding/
├── false-true-mix/          # 단어 분석 결과 (원본판정 false/true 혼합)
│   └── *.json              # 다양한 유사도 패턴의 단어 분석 결과
└── sentence/
    └── mix/                 # 문장 분석 결과 
        └── *.json          # 문장 특화 메트릭이 포함된 분석 결과
```

#### 🧪 테스트 방법
1. `load-json.html`을 브라우저에서 열기
2. "JSON 파일 선택" 버튼 클릭
3. 다음 경로에서 원하는 JSON 파일 선택:
   - **단어 분석 테스트**: `result_embedding/false-true-mix/` 폴더의 JSON 파일
   - **문장 분석 테스트**: `result_embedding/sentence/mix/` 폴더의 JSON 파일
4. 로드된 결과에서 필터링, 상세보기, 승인/거절 기능 테스트

#### 🔍 테스트할 수 있는 기능들
- **고급 필터링**: 유사도 범위, STT Ensemble 점수, 원본판정 필터
- **문장 품질 분석**: 길이, 단어 수, 키워드 포함 여부, 컴포넌트별 점수
- **STT 메트릭 상세보기**: Jaro-Winkler, Levenshtein, Korean Phonetic
- **승인 추천 시스템**: 고품질 후보 자동 추천
- **다양한 내보내기**: JSON, Excel, PDF 내보내기

/*
=============================================================================
프로젝트 구조 및 설계 Documentation
=============================================================================

## 시스템 아키텍처

### 1. 전체 구조
```
index.html (메인 분석 UI)
├── load-json.html (JSON 결과 뷰어)
├── config.js (API 키 설정)
├── parser.js (데이터 파싱 및 그룹핑 모듈)
├── similarity.js (유사도 계산 모듈)
├── stt-similarity.js (STT 특화 유사도 모듈)
├── sentence-similarity.js (문장 특화 유사도 모듈) 
├── preprocessing.js (텍스트 전처리 모듈)
├── displayResults.js (결과 표시 및 렌더링 모듈)
├── management.js (승인/거절, 내보내기 관리)
└── styles.css (다크 테마 스타일)
```

### 2. 핵심 처리 플로우
```
데이터 입력 → 파싱 → 그룹핑 → 데이터 타입 선택 (단어/문장) → 전처리 → 임베딩 → 유사도 계산 (STT + 문장 특화 메트릭 포함) → 결과 표시
```

### 2.1 🆕 데이터 타입 선택
- **단어 분석**: 기존 단어 단위 유사도 분석 (라디오 버튼 선택)
- **문장 분석**: 문장 특화 메트릭 포함 분석 (라디오 버튼 선택)
- **UI 전환**: 선택한 데이터 타입에 따라 표시 방식 변경

### 3. 데이터 처리 과정

#### 3.1 데이터 파싱 및 그룹핑
- CSV/TSV 형태의 로그 데이터를 파싱 (자동 구분자 감지)
- 정답별로 사용자 답변들을 그룹핑
- 중복 제거 및 빈도수 계산

#### 3.2 텍스트 전처리 (preprocessing.js)
**정방향 전처리:**
- **Step 1**: 한글 숫자 → 아라비아 숫자 (일→1, 이→2, 팔→8)
- **Step 2**: 소수점 표현 정규화 (점/쩜→., 8점9→8.9)
- **Step 3**: 단위 정규화 (m→미터, %→퍼센트, g→그램)
- **Step 4**: 숫자 → 한글 변환 (8.9→팔점구, 4400→사천사백)

**역방향 전처리 (제거됨 - 품질 저하로 인한 테스트 후 삭제):**
- **R1-R3**: 한글→숫자, 소수점 정규화, 한글단위→영문
  - 예시: "팔점구 미터" → "8.9 m"
- **R1-R4**: R1-R3 + 복합 한글숫자→아라비아
  - 예시: "사천사백" → "4400"
- **테스트 결과**: 유사도 품질이 정방향 전처리보다 현저히 낮아 제거됨
- **문제점**: 한글→숫자 변환 과정에서 의미 왜곡 및 정확도 하락

#### 3.3 임베딩 생성
- OpenAI text-embedding API를 통해 벡터 임베딩 생성
- 선택된 전처리 단계별로 임베딩 계산
- 중복 텍스트 최적화로 API 호출 절약
- 배치 처리 지원 (최대 2048개)

#### 3.4 하이브리드 유사도 계산 (similarity.js + stt-similarity.js + sentence-similarity.js)
**임베딩 기반 유사도:**
- **기준점**: 정답의 임베딩 벡터
- **측정 대상**: 사용자 발화의 임베딩 벡터
- **코사인 유사도**: 벡터 간 각도/방향 측정 (0~1, 1에 가까울수록 의미적으로 유사)
  - 0.9 이상: 매우 높은 유사도 (거의 동일한 의미)
  - 0.7~0.9: 높은 유사도 (유사한 의미)
  - 0.5~0.7: 중간 유사도 (관련성 있음)
  - 0.5 미만: 낮은 유사도 (관련성 낮음)
- **유클리디안/맨하탄**: 벡터 간 거리 기반 유사도
- **피어슨 상관계수**: 벡터 간 선형 상관관계
- **자카드 유사도**: 이진화된 벡터 교집합/합집합 비율

**🎯 STT 특화 메트릭 (stt-similarity.js):**
- **Jaro-Winkler 유사도**: 부분 일치 및 접두사 가중치 (STT 오인식 패턴)
  - 예시: "캔바" ↔ "캔바 캔" → 0.85+
  - 예시: "프로스케일러" ↔ "크로스케일러" → 0.75+
- **Levenshtein 유사도**: 편집 거리 기반 (글자 수정/삽입/삭제)
  - 예시: "도어 캠프" ↔ "도어캠" → 0.9+
  - 예시: "8인치" ↔ "알 인치" → 0.85+
- **Korean Phonetic 유사도**: 한국어 음성학적 혼동 패턴 (ㅍ↔ㅋ, ㅌ↔ㄷ, ㅔ↔ㅐ 등)
  - 예시: "티타늄" ↔ "티파늄" → 0.8+ (ㅌ/ㅍ 혼동)
  - 예시: "외부" ↔ "웨부" → 0.8+ (ㅚ/ㅞ 혼동)
- **STT Ensemble**: 임베딩 + STT 메트릭 앙상블 점수
  - 기본 가중평균: Jaro-Winkler 40% + Levenshtein 30% + Korean Phonetic 30%
  - (부분 일치를 가장 중시하는 휴리스틱 기반 설정, 실데이터 기반 최적화 가능)

**🎯 문장 특화 메트릭 (sentence-similarity.js):**
- **길이 페널티**: 정답과 후보 문장의 길이 비율 기반 점수 조정
  - 예시: 정답 "안녕하세요" vs 후보 "안녕" → 길이 비율 0.5 → 페널티 적용
- **완성도 점수**: 후보 문장의 완전성 평가 (최소 길이, 단어 수 기준)
  - 예시: 단답형 "네" vs 완전한 문장 "네, 맞습니다" → 완성도 차이
- **키워드 가중 유사도**: 필수 키워드 포함 여부에 따른 유사도 강화
  - 예시: 키워드 "스마트폰"이 포함된 답변 우대
- **STT 보정**: 문장 단위 STT 오류 패턴 보정
- **문장 앙상블**: 키워드 가중(40%) + 기본 유사도(25%) + STT 보정(20%) + 완성도(15%)

### 4. 주요 기능 및 최신 업데이트

#### 4.1 🆕 단어/문장 분석 모드
- **단어 분석 모드**: 기존 단어 단위 유사도 분석
- **문장 분석 모드**: 문장 특화 메트릭 포함 분석 
- **데이터 타입 선택**: UI 라디오 버튼으로 분석 모드 선택
- **자동 UI 전환**: 선택한 모드에 따라 결과 표시 방식 변경

#### 4.2 🤖 AI 모델 지원
- **text-embedding-3-small** (기본, 경제적, 빠름)
- **text-embedding-3-large** (고정밀, 비용 높음, 느림)
- **OpenAI API 없이도 사용 가능** (전처리 + STT 메트릭만)
- UI에서 모델 선택 및 사용 여부 토글

#### 4.3 🎯 STT 특화 메트릭
- **음성 인식 오류 패턴 분석**: 한국어 발음 유사성 고려
- **하이브리드 앙상블**: 임베딩 + STT 메트릭 결합
- **실시간 토글**: STT 메트릭 활성화/비활성화 가능
- **전처리 단계별 STT 메트릭 계산**

#### 4.4 🎯 문장 특화 메트릭 
- **문장 품질 분석**: 길이, 단어 수, 키워드 포함 여부
- **키워드 검증**: 필수 키워드 포함 여부 자동 검증
- **완성도 평가**: 문장의 완전성 점수화
- **길이 기반 페널티**: 정답 대비 길이 비율 고려
- **문장 특화 앙상블**: 다중 메트릭 가중 평균

#### 4.5 📊 고급 필터링 (load-json.html)
- **이중 필터 시스템**: 주요 유사도 & STT Ensemble 동시 필터
- **양방향 필터**: 이상(≥) & 이하(≤) 조건 지원
- **원본판정 필터**: True/False 항목 구분 분석
- **승인 추천 시스템**: 고품질 후보 자동 추천 (0.9/0.9 이상)
- **문장 품질 필터**: 키워드 포함 여부, 문장 길이 필터 

#### 4.6 🔄 유연한 전처리 옵션
- **선택적 단계 활성화**: 원본, 1-3단계, 1-4단계 체크박스 선택
- **전처리 비교 결과**: 각 단계별 유사도 비교 및 최적 방법 자동 선택
- **STT 메트릭과 연동**: 각 전처리 단계별 STT 점수 계산

#### 4.7 🖥️ 사용자 인터페이스
- **반응형 다크 테마**: #1a1a1a 배경, #4fc3f7 포인트 컬러
- **실시간 상태 관리**: 승인/거절 상태 시각적 표시
- **상세 정보 토글**: 유사도 상세보기, STT 메트릭 확장/축소
- **전처리 비교 시각화**: 단계별 결과 비교 및 최적 방법 표시
- **문장 품질 시각화**: 컴포넌트별 점수, 키워드 포함 상태 표시 

#### 4.8 📤 다양한 내보내기 옵션
- **JSON 내보내기**: 완전한 분석 결과 (STT + 문장 메트릭 포함)
- **Excel 내보내기**: 4개 시트 (요약, 상세, 전처리 비교, 원본 데이터)
- **PDF 내보내기**: 모든 상세보기 펼친 상태로 시각적 보고서

#### 4.9 🔍 디버그 및 모니터링
- **3단계 로그 레벨**: 기본(0) → 상세(1) → 모든 로그(2)
- **실시간 조정**: UI에서 디버그 레벨 즉시 변경
- **배치 처리 모니터링**: API 호출 절약률, 중복 제거 통계
- **성능 최적화 로그**: 처리 시간, 메모리 사용량 추적

### 5. 파일 구조 및 역할

#### 5.1 메인 애플리케이션
- **`index.html`**: 메인 분석 도구 (1,603줄)
  - 데이터 입력, 전처리, 분석, 결과 표시
  - STT 메트릭 토글, 승인/거절 관리
- **`load-json.html`**: JSON 결과 뷰어 (50,291바이트)
  - 분석 완료된 JSON 파일 로드 및 시각화
  - 고급 필터링, 승인 추천 시스템

#### 5.2 핵심 모듈
- **`parser.js`**: CSV/TSV 데이터 파싱 및 그룹핑
- **`similarity.js`**: 임베딩 기반 유사도 계산
- **`stt-similarity.js`**: STT 특화 메트릭 계산
- **`sentence-similarity.js`**: 문장 특화 메트릭 계산 
- **`preprocessing.js`**: 정방향 텍스트 전처리
- **`displayResults.js`**: 결과 표시 및 렌더링 (단어/문장 모드 지원)
- **`management.js`**: 승인/거절, 내보내기 관리 (PDF 포함)

#### 5.3 설정 및 스타일
- **`config.js`**: OpenAI API 키 설정
- **`styles.css`**: 다크 테마 통합 스타일시트

=============================================================================

## 기능
1. **데이터 분석**: CSV/TSV 형태의 데이터를 파싱하고 그룹핑
2. **AI 분석**: OpenAI의 임베딩 모델을 사용한 유사도 분석 (multiple models 지원)
3. **텍스트 전처리**: 4단계 전처리 파이프라인 (선택적 적용)
4. **운영자 UI**: 분석 결과를 시각적으로 표시하고 승인/거절 관리
5. **디버그 모드**: 3단계 로그 레벨로 분석 과정 모니터링

## 사용 방법

### 1. 파일 실행
`index.html` 파일을 브라우저에서 열기

### 2. API 키 설정
OpenAI API 키를 입력란에 입력 (또는 "OpenAI 미사용" 체크)

### 3. 데이터 타입 선택 
- **단어 분석**: 기존 단어 단위 분석 (라디오 버튼 선택)
- **문장 분석**: 문장 특화 메트릭 포함 분석 (라디오 버튼 선택)

### 4. 데이터 입력
CSV 형식의 데이터를 텍스트 영역에 입력
- **단어 분석 형식**: `컬럼1,퀴즈ID,컬럼3,컬럼4,컬럼5,컬럼6,컬럼7,정답,컬럼9,사용자답변`
- **문장 분석 형식**: `컬럼1,퀴즈ID,컬럼3,컬럼4,컬럼5,컬럼6,컬럼7,정답,키워드,사용자답변`

### 5. 분석 실행
"분석 시작" 버튼 클릭

### 6. 결과 확인 및 승인/거절
- 각 정답별로 유사어 후보들이 유사도와 출현횟수와 함께 표시됩니다
- **문장 분석의 경우**: 키워드 포함 여부, 문장 품질 분석 추가 표시
- 각 후보에 대해 "승인" 또는 "거절" 버튼으로 관리할 수 있습니다 (TOBE)

## 데이터 형식

### 단어 분석 형식
```
47,1234,15,false,,WORD_SIMILARITY_PASS_FAIL_V2,,스냅드래곤 8,,스냅드래 곰파에
```

### 문장 분석 형식 
```
47,1234,15,false,,SENTENCE_SIMILARITY_V2,,이것은 스마트폰입니다,스마트폰,이것은 스마트 폰이에요
```

## 출력 형식

### 단어 분석 결과
```json
[
  {
    "id": 1,
    "log_user_id": "6499",
    "expected_answer": "스냅드래곤 8",
    "candidates": [
      {
        "word": "스냅드래곤", 
        "similarity": 0.91, 
        "count": 1,
        "similarities": {
          "cosine": 0.91,
          "stt_ensemble": 0.85,
          "stt_jaro_winkler": 0.88
        }
      }
    ]
  }
]
```

### 문장 분석 결과 
```json
[
  {
    "id": 1,
    "keyword": "스마트폰",
    "expected_answer": "이것은 스마트폰입니다",
    "candidates": [
      {
        "word": "이것은 스마트 폰이에요",
        "keyword": "스마트폰",
        "keyword_included": true,
        "similarity": 0.89,
        "similarities": {
          "sentence_enhanced": 0.92,
          "sentence_components": {
            "completeness": 0.85,
            "keywordWeighted": 0.90,
            "lengthPenalty": 0.95
          },
          "sentence_analysis": {
            "keywordIncluded": true,
            "candidateLength": 12,
            "lengthRatio": 0.92
          }
        }
      }
    ]
  }
]
```

## 필요사항
- OpenAI API 키 (선택사항 - STT 메트릭만으로도 사용 가능)

## 주요 특징
- **단어/문장 분석 모드**: 데이터 타입에 따른 최적화된 분석 
- **문장 품질 분석**: 길이, 완성도, 키워드 포함 여부 시각화 
- **하이브리드 유사도**: 임베딩 + STT + 문장 특화 메트릭 결합
- **유사도 색상 구분**: 높음(초록), 중간(주황), 낮음(빨강)
- **실시간 승인/거절**: 상태 표시 및 관리
- **고급 필터링**: 다중 조건 필터 및 승인 추천
- **다양한 내보내기**: JSON, Excel, PDF 지원



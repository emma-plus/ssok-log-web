<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ ì‚¬ë„ ë¶„ì„ ê²°ê³¼ ë·°ì–´ - JSON ë¡œë“œ</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ìœ ì‚¬ë„ ë¶„ì„ ê²°ê³¼ ë·°ì–´</h1>
            <p>JSON íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="jsonFileInput">JSON íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="jsonFileInput" accept=".json" onchange="loadJSONFile(event)">
            </div>

            <div class="input-group">
                <label for="jsonTextInput">ë˜ëŠ” JSON í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥</label>
                <textarea id="jsonTextInput" placeholder="JSON ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°..." style="height: 200px;"></textarea>
                <button class="btn" onclick="loadJSONText()" style="margin-top: 10px;">JSON í…ìŠ¤íŠ¸ ë¡œë“œ</button>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <p>ğŸ”„ JSON ë°ì´í„°ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-controls" style="margin-bottom: 20px; text-align: center;">
                <button class="btn" onclick="approveAll()" style="background: #27ae60; margin-right: 10px;">ëª¨ë‘ ìŠ¹ì¸</button>
                <button class="btn" onclick="rejectAll()" style="background: #e74c3c; margin-right: 10px;">ëª¨ë‘ ê±°ì ˆ</button>
                <button class="btn" onclick="exportResults()" style="background: #9b59b6; margin-right: 10px;">JSON ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn" onclick="exportExcel()" style="background: #2e7d32; margin-right: 10px;">ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn" onclick="exportPDF()" style="background: #e91e63;">ğŸ“„ PDF ë‚´ë³´ë‚´ê¸°</button>
            </div>

            <!-- í•„í„° íŒ¨ë„ -->
            <div class="filter-panel" style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: center;">
                    <div>
                        <label style="color: #4fc3f7; font-weight: bold; margin-bottom: 5px; display: block;">ì£¼ìš” ìœ ì‚¬ë„ í•„í„°</label>
                        <select id="mainSimilarityFilter" onchange="applyFilters()" style="width: 100%; padding: 8px; border: 2px solid #555; border-radius: 8px; background: #3a3a3a; color: #e0e0e0;">
                            <option value="all">ì „ì²´</option>
                            <optgroup label="ì´ìƒ (â‰¥)">
                                <option value="gte_0.9">0.9 ì´ìƒ</option>
                                <option value="gte_0.8">0.8 ì´ìƒ</option>
                                <option value="gte_0.7">0.7 ì´ìƒ</option>
                                <option value="gte_0.6">0.6 ì´ìƒ</option>
                                <option value="gte_0.5">0.5 ì´ìƒ</option>
                                <option value="gte_0.4">0.4 ì´ìƒ</option>
                                <option value="gte_0.3">0.3 ì´ìƒ</option>
                                <option value="gte_0.2">0.2 ì´ìƒ</option>
                                <option value="gte_0.1">0.1 ì´ìƒ</option>
                                <option value="gte_0.0">0.0 ì´ìƒ</option>
                            </optgroup>
                            <optgroup label="ì´í•˜ (â‰¤) - ì›ë³¸íŒì • trueìš©">
                                <option value="lte_1.0">1.0 ì´í•˜</option>
                                <option value="lte_0.9">0.9 ì´í•˜</option>
                                <option value="lte_0.8">0.8 ì´í•˜</option>
                                <option value="lte_0.7">0.7 ì´í•˜</option>
                                <option value="lte_0.6">0.6 ì´í•˜</option>
                                <option value="lte_0.5">0.5 ì´í•˜</option>
                                <option value="lte_0.4">0.4 ì´í•˜</option>
                                <option value="lte_0.3">0.3 ì´í•˜</option>
                                <option value="lte_0.2">0.2 ì´í•˜</option>
                                <option value="lte_0.1">0.1 ì´í•˜</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="color: #4caf50; font-weight: bold; margin-bottom: 5px; display: block;">STT Ensemble í•„í„°</label>
                        <select id="sttEnsembleFilter" onchange="applyFilters()" style="width: 100%; padding: 8px; border: 2px solid #555; border-radius: 8px; background: #3a3a3a; color: #e0e0e0;">
                            <option value="all">ì „ì²´</option>
                            <optgroup label="ì´ìƒ (â‰¥)">
                                <option value="gte_0.9">0.9 ì´ìƒ</option>
                                <option value="gte_0.8">0.8 ì´ìƒ</option>
                                <option value="gte_0.7">0.7 ì´ìƒ</option>
                                <option value="gte_0.6">0.6 ì´ìƒ</option>
                                <option value="gte_0.5">0.5 ì´ìƒ</option>
                                <option value="gte_0.4">0.4 ì´ìƒ</option>
                                <option value="gte_0.3">0.3 ì´ìƒ</option>
                                <option value="gte_0.2">0.2 ì´ìƒ</option>
                                <option value="gte_0.1">0.1 ì´ìƒ</option>
                                <option value="gte_0.0">0.0 ì´ìƒ</option>
                            </optgroup>
                            <optgroup label="ì´í•˜ (â‰¤) - ì›ë³¸íŒì • trueìš©">
                                <option value="lte_1.0">1.0 ì´í•˜</option>
                                <option value="lte_0.9">0.9 ì´í•˜</option>
                                <option value="lte_0.8">0.8 ì´í•˜</option>
                                <option value="lte_0.7">0.7 ì´í•˜</option>
                                <option value="lte_0.6">0.6 ì´í•˜</option>
                                <option value="lte_0.5">0.5 ì´í•˜</option>
                                <option value="lte_0.4">0.4 ì´í•˜</option>
                                <option value="lte_0.3">0.3 ì´í•˜</option>
                                <option value="lte_0.2">0.2 ì´í•˜</option>
                                <option value="lte_0.1">0.1 ì´í•˜</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="color: #ff9800; font-weight: bold; margin-bottom: 5px; display: block;">ì›ë³¸íŒì • í•„í„°</label>
                        <select id="originJudgeFilter" onchange="applyFilters()" style="width: 100%; padding: 8px; border: 2px solid #555; border-radius: 8px; background: #3a3a3a; color: #e0e0e0;">
                            <option value="all">ì „ì²´</option>
                            <option value="true">Trueë§Œ</option>
                            <option value="false">Falseë§Œ</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn" onclick="resetFilters()" style="background: #6c757d; padding: 8px 16px;">í•„í„° ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>

            <!-- ìŠ¹ì¸ ì¶”ì²œ íŒ¨ë„ -->
            <div id="recommendationPanel" style="display: none; background: #1e3a2e; border: 2px solid #4caf50; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span style="color: #4caf50; font-weight: bold; font-size: 1.1rem;">ğŸ¯ ìŠ¹ì¸ ì¶”ì²œ í•­ëª©</span>
                    <span id="recommendationCount" style="color: #4caf50; margin-left: 10px; font-size: 0.9rem;"></span>
                </div>
                <div id="recommendationList"></div>
            </div>

            <div class="info-panel" style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div id="dataInfo"></div>
            </div>
            <div id="results"></div>
        </div>
    </div>

    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì—‘ì…€ ìƒì„±ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ (PDF ìƒì„±ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ (HTMLì„ Canvasë¡œ ë³€í™˜) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- similarity.js ëª¨ë“ˆ ë¡œë“œ -->
    <script src="./similarity.js"></script>
    <!-- management.js ëª¨ë“ˆ ë¡œë“œ (ê´€ë¦¬ ê¸°ëŠ¥) -->
    <script src="./management.js"></script>

    <script>
        let analysisResults = [];
        let approvalStatus = {};
        let originalInputData = []; // ì›ë³¸ ì…ë ¥ ë°ì´í„° ì €ì¥
        let filteredResults = []; // í•„í„°ë§ëœ ê²°ê³¼
        let currentFilters = {
            mainSimilarity: 'all',
            sttEnsemble: 'all',
            originJudge: 'all'
        };

        // JSON íŒŒì¼ ë¡œë“œ
        function loadJSONFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.json')) {
                alert('JSON íŒŒì¼ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    processJSONData(jsonData, file.name);
                } catch (error) {
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                    alert('JSON íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    document.getElementById('loading').style.display = 'none';
                }
            };
            reader.readAsText(file);
        }

        // JSON í…ìŠ¤íŠ¸ ë¡œë“œ
        function loadJSONText() {
            const jsonText = document.getElementById('jsonTextInput').value.trim();
            if (!jsonText) {
                alert('JSON ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            try {
                const jsonData = JSON.parse(jsonText);
                processJSONData(jsonData, 'ì§ì ‘ ì…ë ¥');
            } catch (error) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                alert('JSON ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // JSON ë°ì´í„° ì²˜ë¦¬
        function processJSONData(jsonData, fileName) {
            try {
                console.log('JSON ë°ì´í„° ì²˜ë¦¬ ì‹œì‘:', fileName);

                // ë°ì´í„° ê²€ì¦
                if (!Array.isArray(jsonData)) {
                    throw new Error('JSON ë°ì´í„°ëŠ” ë°°ì—´ í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.');
                }

                if (jsonData.length === 0) {
                    throw new Error('ë¹ˆ ë°ì´í„°ì…ë‹ˆë‹¤.');
                }

                // analysisResultsì— ë°ì´í„° í• ë‹¹
                analysisResults = jsonData;

                // ìŠ¹ì¸ ìƒíƒœ ì´ˆê¸°í™”
                approvalStatus = {};
                analysisResults.forEach(result => {
                    result.candidates.forEach(candidate => {
                        const candidateId = `${result.id}_${candidate.candidate_word}`;
                        approvalStatus[candidateId] = candidate.approval_status || 'pending';
                    });
                });

                // í†µê³„ ì •ë³´ í‘œì‹œ
                displayDataInfo(fileName);

                // í•„í„°ë§ëœ ê²°ê³¼ ì´ˆê¸°í™”
                filteredResults = [...analysisResults];

                // ìŠ¹ì¸ ì¶”ì²œ í•­ëª© ìƒì„±
                generateRecommendations();

                // ê²°ê³¼ í™”ë©´ í‘œì‹œ
                displayWordResults();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';

                console.log('JSON ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ');

            } catch (error) {
                console.error('ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ë°ì´í„° ì •ë³´ í‘œì‹œ
        function displayDataInfo(fileName) {
            const totalGroups = analysisResults.length;
            const totalCandidates = analysisResults.reduce((sum, result) => sum + result.candidates.length, 0);

            const approvedCount = Object.values(approvalStatus).filter(status => status === 'approved').length;
            const rejectedCount = Object.values(approvalStatus).filter(status => status === 'rejected').length;
            const pendingCount = totalCandidates - approvedCount - rejectedCount;

            // STT ë©”íŠ¸ë¦­ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
            const hasSTTMetrics = analysisResults.some(result =>
                result.candidates.some(candidate =>
                    candidate.similarities && Object.keys(candidate.similarities).some(key => key.startsWith('stt_'))
                )
            );

            const infoHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="color: #4fc3f7; font-size: 0.9rem;">íŒŒì¼ëª…</div>
                        <div style="font-weight: bold; margin-top: 5px;">${fileName}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #4fc3f7; font-size: 0.9rem;">ì´ ê·¸ë£¹ ìˆ˜</div>
                        <div style="font-weight: bold; margin-top: 5px;">${totalGroups}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #4fc3f7; font-size: 0.9rem;">ì´ í›„ë³´ ìˆ˜</div>
                        <div style="font-weight: bold; margin-top: 5px;">${totalCandidates}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #27ae60; font-size: 0.9rem;">ìŠ¹ì¸</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #27ae60;">${approvedCount}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #e74c3c; font-size: 0.9rem;">ê±°ì ˆ</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #e74c3c;">${rejectedCount}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #f39c12; font-size: 0.9rem;">ëŒ€ê¸°</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #f39c12;">${pendingCount}ê°œ</div>
                    </div>
                    ${hasSTTMetrics ? `
                    <div style="text-align: center;">
                        <div style="color: #4caf50; font-size: 0.9rem;">STT ë©”íŠ¸ë¦­</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #4caf50;">í¬í•¨ë¨</div>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('dataInfo').innerHTML = infoHTML;
        }

        // í•„í„°ë§ëœ ë°ì´í„° ì •ë³´ ì—…ë°ì´íŠ¸
        function updateFilteredDataInfo() {
            const totalGroups = filteredResults.length;
            const totalCandidates = filteredResults.reduce((sum, result) => sum + result.candidates.length, 0);

            // í˜„ì¬ í•„í„°ë§ëœ ê²°ê³¼ì—ì„œ ìŠ¹ì¸ ìƒíƒœ ê³„ì‚°
            let approvedCount = 0;
            let rejectedCount = 0;

            filteredResults.forEach(result => {
                result.candidates.forEach(candidate => {
                    const candidateId = `${result.id}_${candidate.candidate_word}`;
                    const status = approvalStatus[candidateId] || 'pending';
                    if (status === 'approved') approvedCount++;
                    else if (status === 'rejected') rejectedCount++;
                });
            });

            const pendingCount = totalCandidates - approvedCount - rejectedCount;

            // STT ë©”íŠ¸ë¦­ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
            const hasSTTMetrics = filteredResults.some(result =>
                result.candidates.some(candidate =>
                    candidate.similarities && Object.keys(candidate.similarities).some(key => key.startsWith('stt_'))
                )
            );

            // í•„í„° ìƒíƒœ ì •ë³´
            const filterInfo = [];

            if (currentFilters.mainSimilarity !== 'all') {
                const mainFilter = parseFilterValue(currentFilters.mainSimilarity);
                if (mainFilter.type === 'gte') {
                    filterInfo.push(`ì£¼ìš” ìœ ì‚¬ë„ â‰¥ ${mainFilter.value}`);
                } else if (mainFilter.type === 'lte') {
                    filterInfo.push(`ì£¼ìš” ìœ ì‚¬ë„ â‰¤ ${mainFilter.value}`);
                }
            }

            if (currentFilters.sttEnsemble !== 'all') {
                const sttFilter = parseFilterValue(currentFilters.sttEnsemble);
                if (sttFilter.type === 'gte') {
                    filterInfo.push(`STT Ensemble â‰¥ ${sttFilter.value}`);
                } else if (sttFilter.type === 'lte') {
                    filterInfo.push(`STT Ensemble â‰¤ ${sttFilter.value}`);
                }
            }

            if (currentFilters.originJudge !== 'all') {
                filterInfo.push(`ì›ë³¸íŒì • = ${currentFilters.originJudge}`);
            }

            const infoHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${filterInfo.length > 0 ? `
                    <div style="text-align: center; grid-column: 1 / -1;">
                        <div style="color: #ff9800; font-size: 0.9rem;">ì ìš©ëœ í•„í„°</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #ff9800;">${filterInfo.join(' & ')}</div>
                    </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <div style="color: #4fc3f7; font-size: 0.9rem;">ê·¸ë£¹ ìˆ˜</div>
                        <div style="font-weight: bold; margin-top: 5px;">${totalGroups}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #4fc3f7; font-size: 0.9rem;">í›„ë³´ ìˆ˜</div>
                        <div style="font-weight: bold; margin-top: 5px;">${totalCandidates}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #27ae60; font-size: 0.9rem;">ìŠ¹ì¸</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #27ae60;">${approvedCount}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #e74c3c; font-size: 0.9rem;">ê±°ì ˆ</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #e74c3c;">${rejectedCount}ê°œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #f39c12; font-size: 0.9rem;">ëŒ€ê¸°</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #f39c12;">${pendingCount}ê°œ</div>
                    </div>
                    ${hasSTTMetrics ? `
                    <div style="text-align: center;">
                        <div style="color: #4caf50; font-size: 0.9rem;">STT ë©”íŠ¸ë¦­</div>
                        <div style="font-weight: bold; margin-top: 5px; color: #4caf50;">í¬í•¨ë¨</div>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('dataInfo').innerHTML = infoHTML;
        }

        // ìŠ¹ì¸ ì¶”ì²œ í•­ëª© ìƒì„±
        function generateRecommendations() {
            const recommendations = [];

            analysisResults.forEach(result => {
                result.candidates.forEach(candidate => {
                    const mainSimilarity = candidate.similarity || 0;
                    const sttEnsemble = candidate.similarities?.stt_ensemble || 0;

                    // ì£¼ìš” ìœ ì‚¬ë„ì™€ STT Ensemble ëª¨ë‘ 0.9 ì´ìƒì¸ í•­ëª©
                    if (mainSimilarity >= 0.9 && sttEnsemble >= 0.9) {
                        const candidateId = `${result.id}_${candidate.candidate_word}`;
                        recommendations.push({
                            candidateId: candidateId,
                            resultId: result.id,
                            expectedAnswer: result.expected_answer,
                            candidateWord: candidate.candidate_word,
                            mainSimilarity: mainSimilarity,
                            sttEnsemble: sttEnsemble,
                            frequency: candidate.frequency
                        });
                    }
                });
            });

            // ì¶”ì²œ íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¹€
            const recommendationPanel = document.getElementById('recommendationPanel');
            const recommendationList = document.getElementById('recommendationList');
            const recommendationCount = document.getElementById('recommendationCount');

            if (recommendations.length > 0) {
                recommendationPanel.style.display = 'block';
                recommendationCount.textContent = `(${recommendations.length}ê°œ í•­ëª©)`;

                // ì¶”ì²œ í•­ëª©ì„ ìœ ì‚¬ë„ ìˆœìœ¼ë¡œ ì •ë ¬
                recommendations.sort((a, b) => {
                    if (b.mainSimilarity !== a.mainSimilarity) {
                        return b.mainSimilarity - a.mainSimilarity;
                    }
                    return b.sttEnsemble - a.sttEnsemble;
                });

                const recommendationHTML = recommendations.map(rec => `
                    <div style="background: #2a4a32; border: 1px solid #4caf50; border-radius: 5px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="flex: 1;">
                            <div style="color: #e0e0e0; font-weight: bold;">
                                ID ${rec.resultId}: "${rec.expectedAnswer}" â†’ "${rec.candidateWord}"
                            </div>
                            <div style="color: #b0b0b0; font-size: 0.9rem; margin-top: 3px;">
                                ì£¼ìš” ìœ ì‚¬ë„: <span style="color: #4fc3f7;">${rec.mainSimilarity}</span> |
                                STT Ensemble: <span style="color: #4caf50;">${rec.sttEnsemble}</span> |
                                ì¶œí˜„: ${rec.frequency}íšŒ
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn" onclick="goToCandidate('${rec.candidateId}')" style="background: #2196f3; padding: 5px 10px; font-size: 0.8rem;">ë°”ë¡œê°€ê¸°</button>
                            <button class="btn" onclick="approveCandidate('${rec.candidateId}')" style="background: #4caf50; padding: 5px 10px; font-size: 0.8rem;">ìŠ¹ì¸</button>
                        </div>
                    </div>
                `).join('');

                recommendationList.innerHTML = recommendationHTML;
            } else {
                recommendationPanel.style.display = 'none';
            }
        }

        // íŠ¹ì • í›„ë³´ë¡œ ì´ë™
        function goToCandidate(candidateId) {
            const element = document.getElementById(`candidate_${candidateId}`);
            if (element) {
                element.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                // í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
                element.style.boxShadow = '0 0 20px #4caf50';
                setTimeout(() => {
                    element.style.boxShadow = '';
                }, 2000);
            }
        }

        // í•„í„° ê°’ íŒŒì‹± í•¨ìˆ˜
        function parseFilterValue(filterValue) {
            if (filterValue === 'all') return { type: 'all' };

            if (filterValue.startsWith('gte_')) {
                return { type: 'gte', value: parseFloat(filterValue.substring(4)) };
            } else if (filterValue.startsWith('lte_')) {
                return { type: 'lte', value: parseFloat(filterValue.substring(4)) };
            }

            // ë ˆê±°ì‹œ ì§€ì› (ì´ì „ ë²„ì „ê³¼ì˜ í˜¸í™˜ì„±)
            return { type: 'gte', value: parseFloat(filterValue) };
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            const mainSimilarityFilter = document.getElementById('mainSimilarityFilter').value;
            const sttEnsembleFilter = document.getElementById('sttEnsembleFilter').value;
            const originJudgeFilter = document.getElementById('originJudgeFilter').value;

            currentFilters.mainSimilarity = mainSimilarityFilter;
            currentFilters.sttEnsemble = sttEnsembleFilter;
            currentFilters.originJudge = originJudgeFilter;

            // í•„í„° ê°’ë“¤ íŒŒì‹±
            const mainFilter = parseFilterValue(mainSimilarityFilter);
            const sttFilter = parseFilterValue(sttEnsembleFilter);

            // í•„í„°ë§ ë¡œì§
            filteredResults = analysisResults.filter(result => {
                // ê·¸ë£¹ ë‚´ì—ì„œ í•„í„° ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í›„ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
                const hasMatchingCandidate = result.candidates.some(candidate => {
                    const mainSimilarity = candidate.similarity || 0;
                    const sttEnsemble = candidate.similarities?.stt_ensemble || 0;
                    const originJudge = candidate.origin_judge;

                    // ì£¼ìš” ìœ ì‚¬ë„ í•„í„° í™•ì¸
                    let mainMatch = true;
                    if (mainFilter.type === 'gte') {
                        mainMatch = mainSimilarity >= mainFilter.value;
                    } else if (mainFilter.type === 'lte') {
                        mainMatch = mainSimilarity <= mainFilter.value;
                    }

                    // STT Ensemble í•„í„° í™•ì¸
                    let sttMatch = true;
                    if (sttFilter.type === 'gte') {
                        sttMatch = sttEnsemble >= sttFilter.value;
                    } else if (sttFilter.type === 'lte') {
                        sttMatch = sttEnsemble <= sttFilter.value;
                    }

                    // ì›ë³¸íŒì • í•„í„° í™•ì¸
                    let originMatch = true;
                    if (originJudgeFilter === 'true') {
                        originMatch = originJudge === 'true' || originJudge === true;
                    } else if (originJudgeFilter === 'false') {
                        originMatch = originJudge === 'false' || originJudge === false;
                    }

                    return mainMatch && sttMatch && originMatch;
                });

                return hasMatchingCandidate;
            }).map(result => {
                // ê° ê·¸ë£¹ì—ì„œ í•„í„° ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í›„ë³´ë§Œ í¬í•¨
                const filteredCandidates = result.candidates.filter(candidate => {
                    const mainSimilarity = candidate.similarity || 0;
                    const sttEnsemble = candidate.similarities?.stt_ensemble || 0;
                    const originJudge = candidate.origin_judge;

                    // ì£¼ìš” ìœ ì‚¬ë„ í•„í„° í™•ì¸
                    let mainMatch = true;
                    if (mainFilter.type === 'gte') {
                        mainMatch = mainSimilarity >= mainFilter.value;
                    } else if (mainFilter.type === 'lte') {
                        mainMatch = mainSimilarity <= mainFilter.value;
                    }

                    // STT Ensemble í•„í„° í™•ì¸
                    let sttMatch = true;
                    if (sttFilter.type === 'gte') {
                        sttMatch = sttEnsemble >= sttFilter.value;
                    } else if (sttFilter.type === 'lte') {
                        sttMatch = sttEnsemble <= sttFilter.value;
                    }

                    // ì›ë³¸íŒì • í•„í„° í™•ì¸
                    let originMatch = true;
                    if (originJudgeFilter === 'true') {
                        originMatch = originJudge === 'true' || originJudge === true;
                    } else if (originJudgeFilter === 'false') {
                        originMatch = originJudge === 'false' || originJudge === false;
                    }

                    return mainMatch && sttMatch && originMatch;
                });

                return {
                    ...result,
                    candidates: filteredCandidates
                };
            });

            // ê²°ê³¼ ë‹¤ì‹œ í‘œì‹œ
            displayWordResults();

            // í•„í„°ë§ëœ ë°ì´í„° ì •ë³´ ì—…ë°ì´íŠ¸
            updateFilteredDataInfo();

            console.log(`í•„í„° ì ìš©:`, {
                mainSimilarity: mainSimilarityFilter,
                sttEnsemble: sttEnsembleFilter,
                originJudge: originJudgeFilter
            });
            console.log(`í•„í„°ë§ ê²°ê³¼: ${filteredResults.length}ê°œ ê·¸ë£¹, ì´ ${filteredResults.reduce((sum, r) => sum + r.candidates.length, 0)}ê°œ í›„ë³´`);
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('mainSimilarityFilter').value = 'all';
            document.getElementById('sttEnsembleFilter').value = 'all';
            document.getElementById('originJudgeFilter').value = 'all';
            currentFilters.mainSimilarity = 'all';
            currentFilters.sttEnsemble = 'all';
            currentFilters.originJudge = 'all';
            filteredResults = [...analysisResults];
            displayWordResults();
            updateFilteredDataInfo();
            console.log('í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // STT ë©”íŠ¸ë¦­ ì´ë¦„ì„ ì‚¬ìš©ì ì¹œí™”ì ì¸ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
        function getSTTMethodDisplayName(method) {
            const nameMap = {
                'stt_ensemble': 'STT Ensemble',
                'stt_enhanced': 'STT Enhanced',
                'jaroWinkler': 'STT Jaro-Winkler',
                'levenshtein': 'STT Levenshtein',
                'phonetic': 'STT Korean Phonetic',
                'stt_jaro_winkler': 'STT Jaro-Winkler',
                'stt_levenshtein': 'STT Levenshtein',
                'stt_phonetic': 'STT Korean Phonetic'
            };
            return nameMap[method] || method;
        }

        // ë¬¸ì¥ í’ˆì§ˆ ë¶„ì„ HTML ìƒì„± í•¨ìˆ˜
        function generateSentenceQualityHTML(similarities) {
            const sentenceComponents = similarities.sentence_components || {};
            const sentenceAnalysis = similarities.sentence_analysis || {};
            const hasSentenceEnhanced = similarities.sentence_enhanced !== undefined;

            if (!hasSentenceEnhanced) return '';

            const qualityData = [];

            // ë¬¸ì¥ ê¸¸ì´ ë¶„ì„
            if (sentenceAnalysis.candidateLength !== undefined) {
                const lengthRatio = sentenceAnalysis.lengthRatio || 0;
                const lengthStatus = lengthRatio > 0.7 ? 'good' : lengthRatio > 0.3 ? 'medium' : 'poor';
                qualityData.push({
                    label: 'ë¬¸ì¥ ê¸¸ì´',
                    value: `${sentenceAnalysis.candidateLength}ì (ë¹„ìœ¨: ${(lengthRatio * 100).toFixed(1)}%)`,
                    status: lengthStatus
                });
            }

            // ë‹¨ì–´ ìˆ˜
            if (sentenceAnalysis.wordCount !== undefined) {
                const wordStatus = sentenceAnalysis.wordCount >= 5 ? 'good' : sentenceAnalysis.wordCount >= 3 ? 'medium' : 'poor';
                qualityData.push({
                    label: 'ë‹¨ì–´ ìˆ˜',
                    value: `${sentenceAnalysis.wordCount}ê°œ`,
                    status: wordStatus
                });
            }

            // í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€
            if (sentenceAnalysis.keywordIncluded !== undefined) {
                qualityData.push({
                    label: 'í‚¤ì›Œë“œ í¬í•¨',
                    value: sentenceAnalysis.keywordIncluded ? 'YES' : 'NO',
                    status: sentenceAnalysis.keywordIncluded ? 'good' : 'poor'
                });
            }

            // ì»´í¬ë„ŒíŠ¸ë³„ ì ìˆ˜
            const componentData = [];
            if (sentenceComponents.completeness !== undefined) {
                const score = (sentenceComponents.completeness * 100).toFixed(1);
                const status = sentenceComponents.completeness >= 0.7 ? 'good' : sentenceComponents.completeness >= 0.4 ? 'medium' : 'poor';
                componentData.push({ label: 'ë¬¸ì¥ ì™„ì„±ë„', value: `${score}%`, status });
            }

            if (sentenceComponents.keywordWeighted !== undefined) {
                const score = (sentenceComponents.keywordWeighted * 100).toFixed(1);
                const status = sentenceComponents.keywordWeighted >= 0.7 ? 'good' : sentenceComponents.keywordWeighted >= 0.4 ? 'medium' : 'poor';
                componentData.push({ label: 'í‚¤ì›Œë“œ ê°€ì¤‘ ìœ ì‚¬ë„', value: `${score}%`, status });
            }

            if (sentenceComponents.sttCorrected !== undefined) {
                const score = (sentenceComponents.sttCorrected * 100).toFixed(1);
                const status = sentenceComponents.sttCorrected >= 0.7 ? 'good' : sentenceComponents.sttCorrected >= 0.4 ? 'medium' : 'poor';
                componentData.push({ label: 'STT ë³´ì • ì ìˆ˜', value: `${score}%`, status });
            }

            if (sentenceComponents.lengthPenalty !== undefined) {
                const score = (sentenceComponents.lengthPenalty * 100).toFixed(1);
                const status = sentenceComponents.lengthPenalty >= 0.8 ? 'good' : sentenceComponents.lengthPenalty >= 0.5 ? 'medium' : 'poor';
                componentData.push({ label: 'ê¸¸ì´ í˜ë„í‹°', value: `${score}%`, status });
            }

            const getStatusColor = (status) => {
                switch(status) {
                    case 'good': return '#4caf50';
                    case 'medium': return '#ff9800';
                    case 'poor': return '#f44336';
                    default: return '#888';
                }
            };

            return `
                <div style="margin-top: 15px; padding: 12px; background: #2a2a2a; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <strong style="color: #ff9800;">ğŸ“Š ë¬¸ì¥ í’ˆì§ˆ ë¶„ì„</strong>
                    <div style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
                        ${qualityData.map(item => `
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #ccc;">${item.label}:</span>
                                <span style="color: ${getStatusColor(item.status)}; font-weight: bold;">${item.value}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${componentData.length > 0 ? `
                        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #444;">
                            <strong style="color: #4fc3f7; font-size: 0.9rem;">ğŸ”§ ìƒì„¸ ì ìˆ˜ ë¶„ì„</strong>
                            <div style="margin-top: 8px; font-size: 0.8rem;">
                                ${componentData.map(item => `
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="color: #bbb;">${item.label}:</span>
                                        <span style="color: ${getStatusColor(item.status)}; font-weight: bold;">${item.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ë°ì´í„° íƒ€ì… ê°ì§€ í•¨ìˆ˜
        function detectDataType(analysisResults) {
            if (analysisResults.length === 0) return 'word';
            
            // ì²« ë²ˆì§¸ ê²°ê³¼ì˜ ì²« ë²ˆì§¸ í›„ë³´ë¥¼ í™•ì¸
            const firstCandidate = analysisResults[0].candidates[0];
            
            // keyword í•„ë“œê°€ ìˆê³  sentence_enhancedë‚˜ sentence_componentsê°€ ìˆìœ¼ë©´ ë¬¸ì¥
            if (firstCandidate.keyword && 
                (firstCandidate.similarities?.sentence_enhanced !== undefined || 
                 firstCandidate.similarities?.sentence_components !== undefined)) {
                return 'sentence';
            }
            
            return 'word';
        }

        // index.htmlì˜ displayWordResults() í•¨ìˆ˜ì™€ ë™ì¼í•œ ë¡œì§ (í•„í„°ë§ëœ ê²°ê³¼ ì‚¬ìš©)
        function displayWordResults() {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            // í•„í„°ë§ëœ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
            if (filteredResults.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <h3>í•„í„° ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>í•„í„° ì¡°ê±´ì„ ì¡°ì •í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            filteredResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';

                const candidatesHTML = result.candidates.map(candidate => {
                    const similarityClass = candidate.similarity >= 0.8 ? 'similarity-high' :
                                           candidate.similarity >= 0.6 ? 'similarity-medium' : 'similarity-low';

                    const candidateId = `${result.id}_${candidate.candidate_word}`;
                    const status = approvalStatus[candidateId] || '';

                    // ìœ ì‚¬ë„ ìƒì„¸ ì •ë³´ ìƒì„±
                    const similarities = candidate.similarities || {};
                    const analysis = SimilarityCalculator.analyzeSimilarities(similarities);

                    // ë°ì´í„° íƒ€ì… ê°ì§€
                    const dataType = detectDataType(filteredResults);
                    const isSentenceData = dataType === 'sentence';

                    // ë¬¸ì¥ íŠ¹í™” ì •ë³´ ì¶”ì¶œ
                    const sentenceComponents = similarities.sentence_components || {};
                    const sentenceAnalysis = similarities.sentence_analysis || {};
                    const hasSentenceEnhanced = similarities.sentence_enhanced !== undefined;
                    const keywordClass = candidate.keyword_included ? 'similarity-high' : 'similarity-low';

                    // STT ì™¸ì˜ ìµœê³  ìœ ì‚¬ë„ ë©”íŠ¸ë¦­ ì°¾ê¸° (ë¬¸ì¥ì˜ ê²½ìš° sentence_ ì œì™¸)
                    const nonSTTSimilarities = Object.keys(similarities)
                        .filter(method => !method.startsWith('stt_') && (isSentenceData ? !method.startsWith('sentence_') : true))
                        .reduce((obj, method) => {
                            obj[method] = similarities[method];
                            return obj;
                        }, {});

                    const nonSTTAnalysis = Object.keys(nonSTTSimilarities).length > 0 ?
                        SimilarityCalculator.analyzeSimilarities(nonSTTSimilarities) : null;

                    // STT Ensemble ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    const sttEnsembleScore = similarities.stt_ensemble || null;

                    // STT íŠ¹í™” ë©”íŠ¸ë¦­ë“¤ë§Œ ì¶”ì¶œí•˜ì—¬ ìµœê³ ê°’ ì°¾ê¸°
                    const sttMetrics = Object.keys(similarities)
                        .filter(method => method.startsWith('stt_') || ['jaroWinkler', 'levenshtein', 'phonetic'].includes(method))
                        .reduce((obj, method) => {
                            obj[method] = similarities[method];
                            return obj;
                        }, {});

                    const sttAnalysis = Object.keys(sttMetrics).length > 0 ?
                        SimilarityCalculator.analyzeSimilarities(sttMetrics) : null;

                    const similarityDetailsHTML = Object.keys(similarities)
                        .filter(method => isSentenceData ? !method.startsWith('sentence_') : true) // ë¬¸ì¥ íŠ¹í™” ë©”íŠ¸ë¦­ ì œì™¸
                        .map(method => {
                        const value = similarities[method];
                        let className = 'similarity-method';

                        // STT ë©”íŠ¸ë¦­ êµ¬ë¶„ í‘œì‹œ
                        if (method.startsWith('stt_')) {
                            className += ' stt-metric';
                        }

                        if (analysis.highest && method === analysis.highest.method) {
                            className += ' best';
                        } else if (analysis.lowest && method === analysis.lowest.method) {
                            className += ' worst';
                        }

                        // STT ë©”íŠ¸ë¦­ì˜ ê²½ìš° ë” ì¹œìˆ™í•œ ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
                        let displayName = getSTTMethodDisplayName(method);
                        if (method === 'stt_ensemble') displayName = 'STT Ensemble â­';

                        return `<span class="${className}">${displayName}: ${value}</span>`;
                    }).join(' ');

                    // ì „ì²˜ë¦¬ ë¹„êµ ê²°ê³¼ HTML ìƒì„± (ì„ íƒëœ ë‹¨ê³„ë§Œ) - ë‹¨ì–´ìš©
                    let preprocessingComparisonHTML = '';
                    if (candidate.preprocessing_comparison && Object.keys(candidate.preprocessing_comparison).length > 0) {
                        const stageNames = {
                            'original': 'ì›ë³¸',
                            'step13': '1-3ë‹¨ê³„',
                            'step14': '1-4ë‹¨ê³„',
                            'reverseR13': 'R1-R3ë‹¨ê³„',
                            'reverseR14': 'R1-R4ë‹¨ê³„'
                        };

                        preprocessingComparisonHTML = `
                            <div style="margin-top: 15px; padding: 10px; background: #333; border-radius: 5px;">
                                <strong>ì „ì²˜ë¦¬ ë¹„êµ ê²°ê³¼:</strong><br>
                                ${Object.keys(candidate.preprocessing_comparison).map(stage => {
                                    const comparison = candidate.preprocessing_comparison[stage];
                                    const stageName = stageNames[stage] || stage;
                                    const isBest = candidate.best_preprocessing_method === stage;

                                    // ê° ë‹¨ê³„ë³„ ì£¼ìš” ìœ ì‚¬ë„ë§Œ í‘œì‹œ (ì½”ì‚¬ì¸ + STT Ensemble)
                                    let stageMetrics = `<span class="similarity-method${isBest ? ' best' : ''}">${stageName}: ${comparison.similarity.toFixed(3)}</span>`;

                                    // STT Ensemble ì ìˆ˜ê°€ ìˆë‹¤ë©´ ì¶”ê°€ í‘œì‹œ
                                    if (comparison.similarities && comparison.similarities.stt_ensemble) {
                                        stageMetrics += ` <span class="similarity-method stt-metric">STT: ${comparison.similarities.stt_ensemble}</span>`;
                                    }

                                    return `
                                        <div style="margin-bottom: 8px;">
                                            ${stageMetrics}
                                            <span style="color: #888; font-size: 0.8rem; display: block; margin-left: 10px;">
                                                ("${comparison.expected_text}" vs "${comparison.candidate_text}")
                                            </span>
                                            ${comparison.similarities && Object.keys(comparison.similarities).filter(k => k.startsWith('stt_')).length > 1 ? `
                                                <div style="margin-left: 10px; margin-top: 3px;">
                                                    <button class="similarity-toggle" onclick="toggleStageSTTDetails('${candidateId}_${stage}')" style="font-size: 0.75rem; padding: 2px 6px;">STT ìƒì„¸</button>
                                                    <div id="stt_details_${candidateId}_${stage}" style="display: none; margin-top: 5px; font-size: 0.8rem;">
                                                        ${Object.keys(comparison.similarities).filter(k => k.startsWith('stt_')).map(method => {
                                                            const value = comparison.similarities[method];
                                                            let displayName = method;
                                                            if (method === 'stt_jaro_winkler') displayName = 'Jaro-Winkler';
                                                            else if (method === 'stt_levenshtein') displayName = 'Levenshtein';
                                                            else if (method === 'stt_phonetic') displayName = 'Korean Phonetic';
                                                            else if (method === 'stt_ensemble') displayName = 'Ensemble â­';
                                                            return `<span class="stt-metric">${displayName}: ${value}</span>`;
                                                        }).join(' ')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                                ${candidate.best_preprocessing_method ? `
                                    <span style="color: #4fc3f7; font-weight: bold; margin-top: 5px; display: block;">
                                        ìµœì  ë°©ë²•: ${stageNames[candidate.best_preprocessing_method] || candidate.best_preprocessing_method}
                                    </span>
                                ` : ''}
                            </div>
                        `;
                    }

                    // ë¬¸ì¥ í’ˆì§ˆ ë¶„ì„ HTML ìƒì„±
                    const sentenceQualityHTML = isSentenceData ? generateSentenceQualityHTML(similarities) : '';

                    return `
                        <div class="candidate-item ${status}" id="candidate_${candidateId}">
                            <div class="candidate-info">
                                <div class="candidate-word" ${isSentenceData ? 'style="font-size: 0.95rem; line-height: 1.4;"' : ''}>${candidate.candidate_word}</div>
                                <div class="candidate-stats">
                                    Log ID: [${candidate.log_id.join(', ')}] |
                                    ${isSentenceData && candidate.keyword ? `í‚¤ì›Œë“œ: <strong>${candidate.keyword}</strong> |` : ''}
                                    ${isSentenceData ? `í‚¤ì›Œë“œ í¬í•¨: <span class="${keywordClass}">${candidate.keyword_included ? 'YES' : 'NO'}</span><br>` : ''}
                                    ì£¼ìš” ìœ ì‚¬ë„: <span class="${similarityClass}">${nonSTTAnalysis && nonSTTAnalysis.highest ? `${candidate.similarity} (${nonSTTAnalysis.highest.method})` : candidate.similarity}</span>
                                    ${sttAnalysis && sttAnalysis.highest ? ` / <span class="similarity-method stt-metric">${sttAnalysis.highest.value.toFixed(3)}</span>(${getSTTMethodDisplayName(sttAnalysis.highest.method)})` : ''}
                                    ${sttEnsembleScore ? ` / STT Ensemble: <span class="similarity-method stt-metric">${sttEnsembleScore}</span>` : ''}
                                    <button class="similarity-toggle" onclick="toggleSimilarityDetails('${candidateId}')">ìƒì„¸ë³´ê¸°</button>
                                    <br>
                                    ì¶œí˜„íšŸìˆ˜: ${candidate.frequency}íšŒ |
                                    ì›ë³¸íŒì •: <span class="${candidate.origin_judge === 'true' ? 'similarity-high' : 'similarity-low'}">${candidate.origin_judge}</span>
                                </div>
                                <div class="similarity-details" id="similarity_${candidateId}" style="display: none;">
                                    ${hasSentenceEnhanced && isSentenceData ? `
                                        <strong style="color: #4fc3f7;">ğŸ¯ ë¬¸ì¥ íŠ¹í™” ìœ ì‚¬ë„: ${similarities.sentence_enhanced.toFixed(3)}</strong><br>
                                        <span style="color: #888; font-size: 0.85rem;">ê¸°ì¡´ ë°©ì‹ ëŒ€ë¹„ í–¥ìƒëœ ë¬¸ì¥ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.</span>
                                        ${sentenceQualityHTML}
                                        <br>
                                    ` : ''}
                                    <strong>ëª¨ë“  ìœ ì‚¬ë„ ê³„ì‚° ê²°ê³¼:</strong><br>
                                    ${similarityDetailsHTML}
                                    <br><br>
                                    <strong>ë¶„ì„:</strong><br>
                                    â€¢ ìµœê³ ì : ${analysis.highest ? `${analysis.highest.method} (${analysis.highest.value})` : 'N/A'}<br>
                                    â€¢ ìµœì €ì : ${analysis.lowest ? `${analysis.lowest.method} (${analysis.lowest.value})` : 'N/A'}<br>
                                    â€¢ í‰ê· : ${analysis.average ? analysis.average.toFixed(3) : 'N/A'}<br>
                                    â€¢ ë¶„ì‚°: ${analysis.variance ? analysis.variance.toFixed(3) : 'N/A'}
                                    ${preprocessingComparisonHTML}
                                </div>
                            </div>
                            <div class="candidate-actions">
                                <button class="btn-approve" onclick="approveCandidate('${candidateId}')">ìŠ¹ì¸</button>
                                <button class="btn-reject" onclick="rejectCandidate('${candidateId}')">ê±°ì ˆ</button>
                            </div>
                        </div>
                    `;
                }).join('');

                const dataType = detectDataType(filteredResults);
                const isSentenceData = dataType === 'sentence';

                resultDiv.innerHTML = `
                    <div class="result-header">
                        <h3>ID: ${result.id}${isSentenceData && result.keyword ? ` | í‚¤ì›Œë“œ: "${result.keyword}"` : ''}</h3>
                        <div class="expected" ${isSentenceData ? 'style="font-size: 0.95rem; line-height: 1.4; margin-top: 10px;"' : ''}>ì •ë‹µ: "${result.expected_answer}"</div>
                    </div>
                    <div class="candidates-list">
                        ${candidatesHTML}
                    </div>
                `;

                resultsContainer.appendChild(resultDiv);
            });
        }

        // ìœ ì‚¬ë„ ìƒì„¸ì •ë³´ í† ê¸€ í•¨ìˆ˜
        function toggleSimilarityDetails(candidateId) {
            const detailsElement = document.getElementById(`similarity_${candidateId}`);
            const toggleButton = event.target;

            if (detailsElement.style.display === 'none') {
                detailsElement.style.display = 'block';
                toggleButton.textContent = 'ìˆ¨ê¸°ê¸°';
            } else {
                detailsElement.style.display = 'none';
                toggleButton.textContent = 'ìƒì„¸ë³´ê¸°';
            }
        }

        // STT ìƒì„¸ ì •ë³´ í† ê¸€ í•¨ìˆ˜ (ì „ì²˜ë¦¬ ë¹„êµìš©)
        function toggleStageSTTDetails(stageId) {
            const element = document.getElementById(`stt_details_${stageId}`);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        // PDF ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜ (index.htmlê³¼ ë™ì¼)
        async function exportPDF() {
            if (analysisResults.length === 0) {
                alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € JSON ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                console.log('PDF ë‚´ë³´ë‚´ê¸° ì‹œì‘...');

                // ëª¨ë“  ìƒì„¸ë³´ê¸° í¼ì¹˜ê¸°
                const allDetailElements = document.querySelectorAll('.similarity-details');
                const originalDisplayStates = [];

                allDetailElements.forEach((element, index) => {
                    originalDisplayStates[index] = element.style.display;
                    element.style.display = 'block';
                });

                // ëª¨ë“  STT ìƒì„¸ ì •ë³´ë„ í¼ì¹˜ê¸°
                const allSTTDetails = document.querySelectorAll('[id^="stt_details_"]');
                const originalSTTStates = [];

                allSTTDetails.forEach((element, index) => {
                    originalSTTStates[index] = element.style.display;
                    element.style.display = 'block';
                });

                // ì•½ê°„ì˜ ëŒ€ê¸° ì‹œê°„ìœ¼ë¡œ ë Œë”ë§ ì™„ë£Œ ë³´ì¥
                await new Promise(resolve => setTimeout(resolve, 500));

                // ê²°ê³¼ ì˜ì—­ë§Œ ìº¡ì²˜
                const resultsElement = document.getElementById('results');
                if (!resultsElement) {
                    throw new Error('ê²°ê³¼ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // html2canvasë¡œ ìº¡ì²˜
                const canvas = await html2canvas(resultsElement, {
                    useCORS: true,
                    allowTaint: false,
                    scale: 1.5,
                    backgroundColor: '#1a1a1a',
                    logging: true,
                    height: resultsElement.scrollHeight,
                    width: resultsElement.scrollWidth,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: resultsElement.scrollWidth,
                    windowHeight: resultsElement.scrollHeight,
                    // document.write ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì˜µì…˜
                    foreignObjectRendering: false,
                    removeContainer: true
                });

                // PDF ìƒì„±
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgData = canvas.toDataURL('image/png', 0.8); // ì••ì¶•ë¥  ì¶”ê°€
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const scaledWidth = imgWidth * ratio;
                const scaledHeight = imgHeight * ratio;

                const x = (pdfWidth - scaledWidth) / 2;
                const y = 10;

                if (scaledHeight > pdfHeight - 20) {
                    const pageHeight = pdfHeight - 20;
                    const totalPages = Math.ceil(scaledHeight / pageHeight);

                    for (let page = 0; page < totalPages; page++) {
                        if (page > 0) {
                            pdf.addPage();
                        }

                        const sourceY = (page * pageHeight) / ratio;
                        const sourceHeight = Math.min(pageHeight / ratio, imgHeight - sourceY);

                        const partCanvas = document.createElement('canvas');
                        partCanvas.width = imgWidth;
                        partCanvas.height = sourceHeight;
                        const partCtx = partCanvas.getContext('2d');

                        const img = new Image();
                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                partCtx.drawImage(img, 0, sourceY, imgWidth, sourceHeight, 0, 0, imgWidth, sourceHeight);
                                resolve();
                            };
                            img.onerror = reject;
                            img.src = imgData;
                        });

                        const partImgData = partCanvas.toDataURL('image/png');
                        pdf.addImage(partImgData, 'PNG', x, y, scaledWidth, sourceHeight * ratio);
                    }
                } else {
                    pdf.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);
                }

                pdf.setProperties({
                    title: `ìœ ì‚¬ë„ ë¶„ì„ ê²°ê³¼ ë·°ì–´ - ${new Date().toISOString().split('T')[0]}`,
                    subject: 'JSON ë¡œë“œ ë¶„ì„ ê²°ê³¼',
                    author: 'AI ë¶„ì„ ì‹œìŠ¤í…œ',
                    creator: 'Claude Code'
                });

                const fileName = `loaded_similarity_results_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                console.log('PDF íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ì›ë˜ ìƒíƒœë¡œ ë³µì›
                allDetailElements.forEach((element, index) => {
                    element.style.display = originalDisplayStates[index];
                });

                allSTTDetails.forEach((element, index) => {
                    element.style.display = originalSTTStates[index];
                });

            } catch (error) {
                console.error('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                alert('PDF íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

    </script>
</body>
</html>
